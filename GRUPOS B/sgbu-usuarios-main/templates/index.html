<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGBU - Cadastro de Usu√°rios</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Sistema de Gerenciamento de Biblioteca</h1>
            <h2>M√≥dulo: Cadastro de Usu√°rios - Equipe 1</h2>
        </header>

        <main>
            <!-- Formul√°rio de Cadastro -->
            <section class="form-section">
                <h3>‚ûï Cadastrar Novo Usu√°rio</h3>
                <form id="formCadastro">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome">Nome Completo *</label>
                            <input type="text" id="nome" name="nome" required 
                                   minlength="1" maxlength="100" 
                                   placeholder="Ex: Jo√£o Silva">
                        </div>

                        <div class="form-group">
                            <label for="matricula">Matr√≠cula *</label>
                            <input type="text" id="matricula" name="matricula" required 
                                   minlength="5" maxlength="20" 
                                   placeholder="Ex: ALU12345">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipo">Tipo de Usu√°rio *</label>
                            <select id="tipo" name="tipo" required>
                                <option value="">Selecione...</option>
                                <option value="ALUNO">üéì Aluno</option>
                                <option value="PROFESSOR">üë®‚Äçüè´ Professor</option>
                                <option value="FUNCIONARIO">üëî Funcion√°rio</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="email">Email (opcional)</label>
                            <input type="email" id="email" name="email" 
                                   placeholder="Ex: joao@email.com">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        ‚úÖ Cadastrar Usu√°rio
                    </button>
                </form>
            </section>

            <!-- Mensagem de Feedback -->
            <div id="mensagem" class="mensagem"></div>

            <!-- Lista de Usu√°rios -->
            <section class="list-section">
                <h3>üë• Usu√°rios Cadastrados ({{ usuarios|length }})</h3>
                
                {% if usuarios %}
                <div class="table-container">
                    <table id="tabelaUsuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Matr√≠cula</th>
                                <th>Tipo</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Data Registro</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in usuarios %}
                            <tr>
                                <td><strong>#{{ usuario.id }}</strong></td>
                                <td>{{ usuario.nome }}</td>
                                <td><code>{{ usuario.matricula }}</code></td>
                                <td>
                                    <span class="badge badge-{{ usuario.tipo.value.lower() }}">
                                        {% if usuario.tipo.value == 'ALUNO' %}üéì{% elif usuario.tipo.value == 'PROFESSOR' %}üë®‚Äçüè´{% else %}üëî{% endif %}
                                        {{ usuario.tipo.value }}
                                    </span>
                                </td>
                                <td>{{ usuario.email or '‚Äî' }}</td>
                                <td>
                                    <span class="badge badge-status-{{ usuario.status.value.lower() }}">
                                        {{ usuario.status.value }}
                                    </span>
                                </td>
                                <td>{{ usuario.dataRegistro[:10] }}</td>
                                <td>
                                    <button class="btn btn-small btn-danger" 
                                            onclick="removerUsuario({{ usuario.id }},'{{ usuario.nome }}')">
                                        üóëÔ∏è Remover
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>üì≠ Nenhum usu√°rio cadastrado ainda.</p>
                    <p>Use o formul√°rio acima para cadastrar o primeiro usu√°rio!</p>
                </div>
                {% endif %}
            </section>
        </main>

        <footer>
            <p>üéì Equipe 1 - Cadastro de Usu√°rios | TecLearn TABAJARA</p>
            <p>Desenvolvido com TDD (Test Driven Development) | 21 testes passando ‚úÖ</p>
        </footer>
    </div>

    <script>
        // Cadastrar usu√°rio
        document.getElementById('formCadastro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dados = {
                nome: document.getElementById('nome').value.trim(),
                matricula: document.getElementById('matricula').value.trim(),
                tipo: document.getElementById('tipo').value,
            };
            
            try {
                const response = await fetch('/api/usuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                if (response.ok) {
                    const usuario = await response.json();
                    mostrarMensagem(`‚úÖ Usu√°rio "${usuario.nome}" cadastrado com sucesso!`, 'sucesso');
                    document.getElementById('formCadastro').reset();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const erro = await response.json();
                    mostrarMensagem(`‚ùå Erro: ${erro.erro}`, 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao cadastrar usu√°rio. Tente novamente.', 'erro');
            }
        });
        
        // Remover usu√°rio
        async function removerUsuario(id, nome) {
            if (!confirm(`‚ö†Ô∏è Deseja realmente remover o usu√°rio "${nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/usuarios/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    mostrarMensagem(`‚úÖ Usu√°rio "${nome}" removido com sucesso!`, 'sucesso');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const erro = await response.json();
                    mostrarMensagem(`‚ùå Erro: ${erro.erro}`, 'erro');
                }
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao remover usu√°rio. Tente novamente.', 'erro');
            }
        }
        
        // Mostrar mensagem de feedback
        function mostrarMensagem(texto, tipo) {
            const div = document.getElementById('mensagem');
            div.textContent = texto;
            div.className = `mensagem ${tipo}`;
            div.style.display = 'block';
            
            setTimeout(() => {
                div.style.display = 'none';
            }, 5000);
        }
        
        // Valida√ß√£o em tempo real
        document.getElementById('nome').addEventListener('input', function() {
            if (this.value.length > 0 && this.value.length < 1) {
                this.setCustomValidity('Nome deve ter pelo menos 1 caractere');
            } else {
                this.setCustomValidity('');
            }
        });
        
        document.getElementById('matricula').addEventListener('input', function() {
            if (this.value.length > 0 && this.value.length < 5) {
                this.setCustomValidity('Matr√≠cula deve ter entre 5 e 20 caracteres');
            } else {
                this.setCustomValidity('');
            }
        });
    </script>
</body>
</html>